
-- 방문 경로 테이블
CREATE TABLE referral_sources (
    id SERIAL PRIMARY KEY,
    source_name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 약관 버전 테이블
CREATE TABLE terms_versions (
    id SERIAL PRIMARY KEY,
    terms_type VARCHAR(50) NOT NULL, -- 'privacy' 또는 'terms'
    content TEXT NOT NULL,
    version VARCHAR(20) NOT NULL,
    effective_date TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 사용자 테이블
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    username VARCHAR(100) NOT NULL,
    phone_number VARCHAR(20) NOT NULL,
    company_name VARCHAR(200),
    position VARCHAR(100),
    referral_source_id INTEGER REFERENCES referral_sources(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP WITH TIME ZONE
);

-- 약관 동의 이력 테이블
CREATE TABLE user_agreements (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    terms_version_id INTEGER REFERENCES terms_versions(id),
    agreed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(45),
    UNIQUE(user_id, terms_version_id)
);

-- 세션 관리 테이블
CREATE TABLE sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(token)
);

-- 인덱스 생성
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_phone ON users(phone_number);
CREATE INDEX idx_users_company ON users(company_name);
CREATE INDEX idx_user_agreements_user_id ON user_agreements(user_id);
CREATE INDEX idx_sessions_token ON sessions(token);
CREATE INDEX idx_sessions_user_id ON sessions(user_id);

-- updated_at 자동 갱신을 위한 트리거
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();


-- 기본 방문 경로 데이터 입력
INSERT INTO referral_sources (source_name) VALUES 
    ('포털사이트 검색'),
    ('SNS 광고'),
    ('그로우썸 디스코드'),
    ('그로우썸 유투브'),
    ('제휴사'),
    ('온/오프라인 행사'),
    ('오픈채팅방'),
    ('기타'),
    ('지인 소개');

-- 기본 약관 버전 입력
INSERT INTO terms_versions (terms_type, content, version, effective_date) VALUES
    ('terms', '서비스 이용약관 내용...', '1.0', CURRENT_TIMESTAMP),
    ('privacy', '개인정보처리방침 내용...', '1.0', CURRENT_TIMESTAMP);
